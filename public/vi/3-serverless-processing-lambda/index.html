<!DOCTYPE html>
<html lang="vi" class="js csstransforms3d">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.147.8">
    <meta name="description" content="Build a complete weather data ETL pipeline using AWS Lambda, S3, Athena, and QuickSight">
<meta name="author" content="Dang Van Huy">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Xử lý và Chuyển đổi Dữ liệu :: Hệ thống ETL Dữ liệu Thời tiết với AWS</title>

    
    <link href="/css/nucleus.css?1752217735" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1752217735" rel="stylesheet">
    <link href="/css/hybrid.css?1752217735" rel="stylesheet">
    <link href="/css/featherlight.min.css?1752217735" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1752217735" rel="stylesheet">
    <link href="/css/auto-complete.css?1752217735" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1752217735" rel="stylesheet">
    <link href="/css/theme.css?1752217735" rel="stylesheet">
    <link href="/css/hugo-theme.css?1752217735" rel="stylesheet">
    
    <link href="/css/theme-workshop.css?1752217735" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1752217735"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/vi/3-serverless-processing-lambda/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1752217735"></script>
<script type="text/javascript" src="/js/auto-complete.js?1752217735"></script>
<script type="text/javascript">
    
        var baseurl = "\/\/localhost:1313\/\/vi";
    
</script>
<script type="text/javascript" src="/js/search.js?1752217735"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/vi/1-introduction/" title="Giới thiệu" class="dd-item 
        
        
        
        ">
      <a href="/vi/1-introduction/">
          <b>1. </b>Giới thiệu
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/2-data-collection-openweathermap/" title="Thu thập Dữ liệu Thời tiết với OpenWeatherMap" class="dd-item 
        
        
        
        ">
      <a href="/vi/2-data-collection-openweathermap/">
          <b>2. </b>Thu thập Dữ liệu Thời tiết với OpenWeatherMap
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/vi/2-data-collection-openweathermap/2.1-openweathermap-setup/" title="Thiết lập OpenWeatherMap API" class="dd-item 
        
        
        
        ">
      <a href="/vi/2-data-collection-openweathermap/2.1-openweathermap-setup/">
          Thiết lập OpenWeatherMap API
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/2-data-collection-openweathermap/2.2-lambda-weather-collector/" title="Xây dựng Lambda Weather Collector" class="dd-item 
        
        
        
        ">
      <a href="/vi/2-data-collection-openweathermap/2.2-lambda-weather-collector/">
          Xây dựng Lambda Weather Collector
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/2-data-collection-openweathermap/2.3-automated-scheduling/" title="Lập lịch Tự động với CloudWatch Events" class="dd-item 
        
        
        
        ">
      <a href="/vi/2-data-collection-openweathermap/2.3-automated-scheduling/">
          Lập lịch Tự động với CloudWatch Events
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/2-data-collection-openweathermap/2.4-testing-monitoring/" title="Testing và Monitoring Thu thập Thời tiết" class="dd-item 
        
        
        
        ">
      <a href="/vi/2-data-collection-openweathermap/2.4-testing-monitoring/">
          Testing và Monitoring Thu thập Thời tiết
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/3-serverless-processing-lambda/" title="Xử lý và Chuyển đổi Dữ liệu" class="dd-item 
        
        active
        
        ">
      <a href="/vi/3-serverless-processing-lambda/">
          <b>3. </b>Xử lý và Chuyển đổi Dữ liệu
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/4-data-storage-solutions/" title="Phân tích Dữ liệu với Athena" class="dd-item 
        
        
        
        ">
      <a href="/vi/4-data-storage-solutions/">
          <b>4. </b>Phân tích Dữ liệu với Athena
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/5-analytics-visualization/" title="Trực quan hóa Dữ liệu với QuickSight" class="dd-item 
        
        
        
        ">
      <a href="/vi/5-analytics-visualization/">
          <b>5. </b>Trực quan hóa Dữ liệu với QuickSight
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="http://awsstudygroup.com"><i class='fab fa-aws'></i> AWS Study Group - Blog</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="//localhost:1313/3-serverless-processing-lambda/">English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="//localhost:1313/vi/3-serverless-processing-lambda/" selected>Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
     
    
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>23-06-2025</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Author </b> <br>
           
            <i>
                <a href="https://www.linkedin.com/in/imvhuy/"  style="color:orange">Đặng Văn Huy</a>
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='/vi/'>Xây dựng Pipeline ETL Thời tiết Serverless</a> > Xử lý và Chuyển đổi Dữ liệu
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#tổng-quan-module">Tổng quan Module</a></li>
    <li><a href="#những-gì-bạn-sẽ-xây-dựng">Những gì bạn sẽ xây dựng</a></li>
    <li><a href="#điều-kiện-tiên-quyết">Điều kiện tiên quyết</a></li>
    <li><a href="#bước-1-tạo-hàm-lambda-xử-lý-dữ-liệu">Bước 1: Tạo Hàm Lambda Xử lý Dữ liệu</a>
      <ul>
        <li><a href="#11-tạo-thư-mục-hàm-lambda">1.1 Tạo Thư mục Hàm Lambda</a></li>
        <li><a href="#12-tạo-hàm-lambda-hoàn-chỉnh">1.2 Tạo Hàm Lambda Hoàn chỉnh</a></li>
        <li><a href="#13-tạo-file-requirements">1.3 Tạo File Requirements</a></li>
      </ul>
    </li>
    <li><a href="#bước-2-tạo-s3-bucket-cho-dữ-liệu-đã-xử-lý">Bước 2: Tạo S3 Bucket cho Dữ liệu Đã Xử lý</a></li>
    <li><a href="#bước-3-đóng-gói-và-triển-khai-hàm-lambda">Bước 3: Đóng gói và Triển khai Hàm Lambda</a>
      <ul>
        <li><a href="#31-tạo-gói-triển-khai">3.1 Tạo Gói Triển khai</a></li>
        <li><a href="#32-tạo-iam-role-cho-lambda">3.2 Tạo IAM Role cho Lambda</a></li>
        <li><a href="#33-triển-khai-hàm-lambda">3.3 Triển khai Hàm Lambda</a></li>
      </ul>
    </li>
    <li><a href="#bước-4-thiết-lập-s3-event-trigger">Bước 4: Thiết lập S3 Event Trigger</a>
      <ul>
        <li><a href="#41-thêm-quyền-lambda-cho-s3">4.1 Thêm Quyền Lambda cho S3</a></li>
        <li><a href="#42-tạo-s3-event-notification">4.2 Tạo S3 Event Notification</a></li>
      </ul>
    </li>
    <li><a href="#bước-5-kiểm-tra-xử-lý-dữ-liệu">Bước 5: Kiểm tra Xử lý Dữ liệu</a>
      <ul>
        <li><a href="#51-kiểm-tra-thủ-công">5.1 Kiểm tra Thủ công</a></li>
        <li><a href="#52-kiểm-tra-cloudwatch-logs">5.2 Kiểm tra CloudWatch Logs</a></li>
        <li><a href="#53-xác-minh-dữ-liệu-đã-xử-lý">5.3 Xác minh Dữ liệu Đã Xử lý</a></li>
      </ul>
    </li>
    <li><a href="#ví-dụ-biến-đổi-dữ-liệu">Ví dụ biến đổi dữ liệu</a>
      <ul>
        <li><a href="#dữ-liệu-openweathermap-thô">Dữ liệu OpenWeatherMap thô</a></li>
        <li><a href="#dữ-liệu-đã-biến-đổi">Dữ liệu đã biến đổi</a></li>
      </ul>
    </li>
    <li><a href="#giám-sát-và-khắc-phục-sự-cố">Giám sát và Khắc phục Sự cố</a>
      <ul>
        <li><a href="#cloudwatch-metrics">CloudWatch Metrics</a></li>
        <li><a href="#các-vấn-đề-thường-gặp">Các Vấn đề Thường gặp</a></li>
      </ul>
    </li>
    <li><a href="#lợi-ích-của-biến-đổi-dữ-liệu">Lợi ích của biến đổi dữ liệu</a></li>
    <li><a href="#các-bước-tiếp-theo">Các bước tiếp theo</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Xử lý và Chuyển đổi Dữ liệu
            </h1>
          

        



	<h1 id="xử-lý-và-biến-đổi-dữ-liệu">Xử lý và Biến đổi Dữ liệu</h1>
<p>Trong module này, bạn sẽ xây dựng một hàm Lambda để xử lý và biến đổi dữ liệu thời tiết thô được thu thập từ OpenWeatherMap API thành định dạng thân thiện hơn với phân tích. Bước biến đổi này là cần thiết trong bất kỳ pipeline ETL nào để chuẩn bị dữ liệu cho việc phân tích hiệu quả.</p>
<h2 id="tổng-quan-module">Tổng quan Module</h2>
<p>Dữ liệu thời tiết thô từ API thường chứa cấu trúc lồng nhau phức tạp, định dạng không nhất quán và thông tin không cần thiết. Trong module này, chúng ta sẽ biến đổi dữ liệu thô này thành định dạng có cấu trúc, sạch sẽ được tối ưu hóa cho phân tích.</p>
<p><strong>Thời gian:</strong> 45-60 phút<br>
<strong>Chi phí:</strong> ~$0.50</p>
<h2 id="những-gì-bạn-sẽ-xây-dựng">Những gì bạn sẽ xây dựng</h2>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">graph LR
    A[S3 Raw Data] --&gt; B[Lambda Processor]
    B --&gt; C[S3 Processed Data]
    D[CloudWatch Events] --&gt; B

    style B fill:#ff9900,stroke:#232f3e,stroke-width:3px
    style A fill:#f3e5f5
    style C fill:#f3e5f5
</code></pre><h2 id="điều-kiện-tiên-quyết">Điều kiện tiên quyết</h2>
<ul>
<li>Đã hoàn thành Module 2: Thu thập Dữ liệu Thời tiết</li>
<li>Dữ liệu thời tiết thô đã được thu thập trong S3</li>
<li>AWS CLI đã được cấu hình</li>
</ul>
<h2 id="bước-1-tạo-hàm-lambda-xử-lý-dữ-liệu">Bước 1: Tạo Hàm Lambda Xử lý Dữ liệu</h2>
<h3 id="11-tạo-thư-mục-hàm-lambda">1.1 Tạo Thư mục Hàm Lambda</h3>
<p>Tạo thư mục mới cho hàm Lambda của bạn:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir weather-processor
</span></span><span style="display:flex;"><span>cd weather-processor
</span></span></code></pre></div><h3 id="12-tạo-hàm-lambda-hoàn-chỉnh">1.2 Tạo Hàm Lambda Hoàn chỉnh</h3>
<p>Tạo file <code>lambda_function.py</code> với mã sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> boto3
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> datetime
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> decimal <span style="color:#f92672">import</span> Decimal
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cấu hình logging</span>
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger()
</span></span><span style="display:flex;"><span>logger<span style="color:#f92672">.</span>setLevel(logging<span style="color:#f92672">.</span>INFO)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Khởi tạo AWS clients</span>
</span></span><span style="display:flex;"><span>s3_client <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;s3&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lambda_handler</span>(event, context):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Lambda handler chính cho xử lý dữ liệu thời tiết
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        processed_bucket <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;PROCESSED_BUCKET&#39;</span>]
</span></span><span style="display:flex;"><span>        processed_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Xử lý từng S3 event record</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> record <span style="color:#f92672">in</span> event[<span style="color:#e6db74">&#39;Records&#39;</span>]:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Trích xuất bucket và key từ event</span>
</span></span><span style="display:flex;"><span>                source_bucket <span style="color:#f92672">=</span> record[<span style="color:#e6db74">&#39;s3&#39;</span>][<span style="color:#e6db74">&#39;bucket&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>]
</span></span><span style="display:flex;"><span>                source_key <span style="color:#f92672">=</span> record[<span style="color:#e6db74">&#39;s3&#39;</span>][<span style="color:#e6db74">&#39;object&#39;</span>][<span style="color:#e6db74">&#39;key&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Đang xử lý file: </span><span style="color:#e6db74">{</span>source_key<span style="color:#e6db74">}</span><span style="color:#e6db74"> từ bucket: </span><span style="color:#e6db74">{</span>source_bucket<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Lấy dữ liệu thời tiết thô từ S3</span>
</span></span><span style="display:flex;"><span>                response <span style="color:#f92672">=</span> s3_client<span style="color:#f92672">.</span>get_object(Bucket<span style="color:#f92672">=</span>source_bucket, Key<span style="color:#f92672">=</span>source_key)
</span></span><span style="display:flex;"><span>                raw_data <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(response[<span style="color:#e6db74">&#39;Body&#39;</span>]<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Biến đổi dữ liệu thời tiết</span>
</span></span><span style="display:flex;"><span>                processed_data <span style="color:#f92672">=</span> transform_weather_data(raw_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Tạo key cho file đã xử lý</span>
</span></span><span style="display:flex;"><span>                processed_key <span style="color:#f92672">=</span> source_key<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;raw/&#39;</span>, <span style="color:#e6db74">&#39;processed/&#39;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;.json&#39;</span>, <span style="color:#e6db74">&#39;_processed.json&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Lưu dữ liệu đã xử lý vào S3</span>
</span></span><span style="display:flex;"><span>                s3_client<span style="color:#f92672">.</span>put_object(
</span></span><span style="display:flex;"><span>                    Bucket<span style="color:#f92672">=</span>processed_bucket,
</span></span><span style="display:flex;"><span>                    Key<span style="color:#f92672">=</span>processed_key,
</span></span><span style="display:flex;"><span>                    Body<span style="color:#f92672">=</span>json<span style="color:#f92672">.</span>dumps(processed_data, indent<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, default<span style="color:#f92672">=</span>decimal_default),
</span></span><span style="display:flex;"><span>                    ContentType<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;application/json&#39;</span>
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                processed_count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Đã xử lý và lưu thành công: </span><span style="color:#e6db74">{</span>processed_key<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Lỗi xử lý record </span><span style="color:#e6db74">{</span>source_key<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>str(e)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;body&#39;</span>: json<span style="color:#f92672">.</span>dumps({
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;message&#39;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Đã xử lý thành công </span><span style="color:#e6db74">{</span>processed_count<span style="color:#e6db74">}</span><span style="color:#e6db74"> files&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;processedCount&#39;</span>: processed_count
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Lỗi thực thi Lambda: </span><span style="color:#e6db74">{</span>str(e)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">500</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;body&#39;</span>: json<span style="color:#f92672">.</span>dumps({
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;error&#39;</span>: str(e)
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">transform_weather_data</span>(raw_data):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Biến đổi dữ liệu OpenWeatherMap thô thành định dạng thân thiện với phân tích
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Trích xuất timestamp</span>
</span></span><span style="display:flex;"><span>        timestamp <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>fromtimestamp(raw_data[<span style="color:#e6db74">&#39;dt&#39;</span>])<span style="color:#f92672">.</span>isoformat() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;Z&#39;</span>
</span></span><span style="display:flex;"><span>        collection_date <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>fromtimestamp(raw_data[<span style="color:#e6db74">&#39;dt&#39;</span>])<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Trích xuất thông tin vị trí và thời tiết cơ bản</span>
</span></span><span style="display:flex;"><span>        processed_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;timestamp&#39;</span>: timestamp,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;city_name&#39;</span>: raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#e6db74">&#39;Unknown&#39;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;country&#39;</span>: raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;sys&#39;</span>, {})<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;country&#39;</span>, <span style="color:#e6db74">&#39;Unknown&#39;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;latitude&#39;</span>: raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;coord&#39;</span>, {})<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;lat&#39;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;longitude&#39;</span>: raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;coord&#39;</span>, {})<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;lon&#39;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;data_collection_date&#39;</span>: collection_date
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Chuyển đổi nhiệt độ</span>
</span></span><span style="display:flex;"><span>        temp_kelvin <span style="color:#f92672">=</span> raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;main&#39;</span>, {})<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;temp&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> temp_kelvin:
</span></span><span style="display:flex;"><span>            processed_data[<span style="color:#e6db74">&#39;temperature_kelvin&#39;</span>] <span style="color:#f92672">=</span> temp_kelvin
</span></span><span style="display:flex;"><span>            processed_data[<span style="color:#e6db74">&#39;temperature_celsius&#39;</span>] <span style="color:#f92672">=</span> round(temp_kelvin <span style="color:#f92672">-</span> <span style="color:#ae81ff">273.15</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>            processed_data[<span style="color:#e6db74">&#39;temperature_fahrenheit&#39;</span>] <span style="color:#f92672">=</span> round((temp_kelvin <span style="color:#f92672">-</span> <span style="color:#ae81ff">273.15</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">9</span><span style="color:#f92672">/</span><span style="color:#ae81ff">5</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Nhiệt độ cảm nhận</span>
</span></span><span style="display:flex;"><span>        feels_like_kelvin <span style="color:#f92672">=</span> raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;main&#39;</span>, {})<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;feels_like&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> feels_like_kelvin:
</span></span><span style="display:flex;"><span>            processed_data[<span style="color:#e6db74">&#39;feels_like_celsius&#39;</span>] <span style="color:#f92672">=</span> round(feels_like_kelvin <span style="color:#f92672">-</span> <span style="color:#ae81ff">273.15</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>            processed_data[<span style="color:#e6db74">&#39;feels_like_fahrenheit&#39;</span>] <span style="color:#f92672">=</span> round((feels_like_kelvin <span style="color:#f92672">-</span> <span style="color:#ae81ff">273.15</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">9</span><span style="color:#f92672">/</span><span style="color:#ae81ff">5</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Các thông số thời tiết khác</span>
</span></span><span style="display:flex;"><span>        processed_data<span style="color:#f92672">.</span>update({
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;humidity_percent&#39;</span>: raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;main&#39;</span>, {})<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;humidity&#39;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;pressure_hpa&#39;</span>: raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;main&#39;</span>, {})<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;pressure&#39;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;visibility_meters&#39;</span>: raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;visibility&#39;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;uv_index&#39;</span>: raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;uvi&#39;</span>)  <span style="color:#75715e"># Nếu có</span>
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mô tả thời tiết</span>
</span></span><span style="display:flex;"><span>        weather_list <span style="color:#f92672">=</span> raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;weather&#39;</span>, [])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> weather_list:
</span></span><span style="display:flex;"><span>            weather <span style="color:#f92672">=</span> weather_list[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>            processed_data<span style="color:#f92672">.</span>update({
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;weather_id&#39;</span>: weather<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;id&#39;</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;weather_main&#39;</span>: weather<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;main&#39;</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;weather_description&#39;</span>: weather<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;description&#39;</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;weather_icon&#39;</span>: weather<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;icon&#39;</span>)
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Thông tin gió</span>
</span></span><span style="display:flex;"><span>        wind_data <span style="color:#f92672">=</span> raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;wind&#39;</span>, {})
</span></span><span style="display:flex;"><span>        processed_data<span style="color:#f92672">.</span>update({
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;wind_speed_ms&#39;</span>: wind_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;speed&#39;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;wind_direction_deg&#39;</span>: wind_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;deg&#39;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;wind_gust_ms&#39;</span>: wind_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;gust&#39;</span>)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Chuyển đổi tốc độ gió sang km/h và mph</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> wind_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;speed&#39;</span>):
</span></span><span style="display:flex;"><span>            processed_data[<span style="color:#e6db74">&#39;wind_speed_kmh&#39;</span>] <span style="color:#f92672">=</span> round(wind_data[<span style="color:#e6db74">&#39;speed&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">3.6</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>            processed_data[<span style="color:#e6db74">&#39;wind_speed_mph&#39;</span>] <span style="color:#f92672">=</span> round(wind_data[<span style="color:#e6db74">&#39;speed&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">2.237</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Độ che phủ mây</span>
</span></span><span style="display:flex;"><span>        processed_data[<span style="color:#e6db74">&#39;cloud_coverage_percent&#39;</span>] <span style="color:#f92672">=</span> raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;clouds&#39;</span>, {})<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;all&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Lượng mưa (nếu có)</span>
</span></span><span style="display:flex;"><span>        rain_data <span style="color:#f92672">=</span> raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;rain&#39;</span>, {})
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> rain_data:
</span></span><span style="display:flex;"><span>            processed_data[<span style="color:#e6db74">&#39;rain_1h_mm&#39;</span>] <span style="color:#f92672">=</span> rain_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;1h&#39;</span>)
</span></span><span style="display:flex;"><span>            processed_data[<span style="color:#e6db74">&#39;rain_3h_mm&#39;</span>] <span style="color:#f92672">=</span> rain_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;3h&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        snow_data <span style="color:#f92672">=</span> raw_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;snow&#39;</span>, {})
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> snow_data:
</span></span><span style="display:flex;"><span>            processed_data[<span style="color:#e6db74">&#39;snow_1h_mm&#39;</span>] <span style="color:#f92672">=</span> snow_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;1h&#39;</span>)
</span></span><span style="display:flex;"><span>            processed_data[<span style="color:#e6db74">&#39;snow_3h_mm&#39;</span>] <span style="color:#f92672">=</span> snow_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;3h&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Thêm các trường dẫn xuất</span>
</span></span><span style="display:flex;"><span>        processed_data<span style="color:#f92672">.</span>update(calculate_derived_fields(processed_data))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> processed_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Lỗi biến đổi dữ liệu thời tiết: </span><span style="color:#e6db74">{</span>str(e)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_derived_fields</span>(data):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Tính toán các chỉ số thời tiết dẫn xuất
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    derived <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Tính chỉ số nhiệt (đơn giản hóa)</span>
</span></span><span style="display:flex;"><span>        temp_f <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;temperature_fahrenheit&#39;</span>)
</span></span><span style="display:flex;"><span>        humidity <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;humidity_percent&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> temp_f <span style="color:#f92672">and</span> humidity:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> temp_f <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">80</span>:  <span style="color:#75715e"># Chỉ số nhiệt chỉ có ý nghĩa trên 80°F</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Công thức chỉ số nhiệt đơn giản</span>
</span></span><span style="display:flex;"><span>                heat_index_f <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">-</span><span style="color:#ae81ff">42.379</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ae81ff">2.04901523</span> <span style="color:#f92672">*</span> temp_f <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ae81ff">10.14333127</span> <span style="color:#f92672">*</span> humidity <span style="color:#f92672">-</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ae81ff">0.22475541</span> <span style="color:#f92672">*</span> temp_f <span style="color:#f92672">*</span> humidity <span style="color:#f92672">-</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ae81ff">6.83783e-3</span> <span style="color:#f92672">*</span> temp_f<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ae81ff">5.481717e-2</span> <span style="color:#f92672">*</span> humidity<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ae81ff">1.22874e-3</span> <span style="color:#f92672">*</span> temp_f<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> humidity <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ae81ff">8.5282e-4</span> <span style="color:#f92672">*</span> temp_f <span style="color:#f92672">*</span> humidity<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ae81ff">1.99e-6</span> <span style="color:#f92672">*</span> temp_f<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> humidity<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                derived[<span style="color:#e6db74">&#39;heat_index_fahrenheit&#39;</span>] <span style="color:#f92672">=</span> round(heat_index_f, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>                derived[<span style="color:#e6db74">&#39;heat_index_celsius&#39;</span>] <span style="color:#f92672">=</span> round((heat_index_f <span style="color:#f92672">-</span> <span style="color:#ae81ff">32</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">/</span><span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mức độ thoải mái dựa trên nhiệt độ và độ ẩm</span>
</span></span><span style="display:flex;"><span>        temp_c <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;temperature_celsius&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> temp_c <span style="color:#f92672">and</span> humidity:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> temp_c <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>:
</span></span><span style="display:flex;"><span>                comfort <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;lạnh&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> temp_c <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">18</span>:
</span></span><span style="display:flex;"><span>                comfort <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;mát&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> temp_c <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">and</span> humidity <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">60</span>:
</span></span><span style="display:flex;"><span>                comfort <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;thoải_mái&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> temp_c <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">and</span> humidity <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">70</span>:
</span></span><span style="display:flex;"><span>                comfort <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ấm&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                comfort <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nóng&#39;</span>
</span></span><span style="display:flex;"><span>            derived[<span style="color:#e6db74">&#39;comfort_level&#39;</span>] <span style="color:#f92672">=</span> comfort
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Tình trạng gió</span>
</span></span><span style="display:flex;"><span>        wind_speed_kmh <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;wind_speed_kmh&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> wind_speed_kmh:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> wind_speed_kmh <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5</span>:
</span></span><span style="display:flex;"><span>                wind_condition <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;tĩnh_lặng&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> wind_speed_kmh <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">20</span>:
</span></span><span style="display:flex;"><span>                wind_condition <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nhẹ&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> wind_speed_kmh <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">40</span>:
</span></span><span style="display:flex;"><span>                wind_condition <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;vừa&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> wind_speed_kmh <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">60</span>:
</span></span><span style="display:flex;"><span>                wind_condition <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;mạnh&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                wind_condition <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;rất_mạnh&#39;</span>
</span></span><span style="display:flex;"><span>            derived[<span style="color:#e6db74">&#39;wind_condition&#39;</span>] <span style="color:#f92672">=</span> wind_condition
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mức độ nghiêm trọng thời tiết</span>
</span></span><span style="display:flex;"><span>        weather_main <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;weather_main&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)<span style="color:#f92672">.</span>lower()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> weather_main:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> weather_main <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;thunderstorm&#39;</span>, <span style="color:#e6db74">&#39;tornado&#39;</span>]:
</span></span><span style="display:flex;"><span>                severity <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nghiêm_trọng&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> weather_main <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;rain&#39;</span>, <span style="color:#e6db74">&#39;snow&#39;</span>, <span style="color:#e6db74">&#39;drizzle&#39;</span>]:
</span></span><span style="display:flex;"><span>                severity <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;vừa&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> weather_main <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;mist&#39;</span>, <span style="color:#e6db74">&#39;fog&#39;</span>, <span style="color:#e6db74">&#39;haze&#39;</span>]:
</span></span><span style="display:flex;"><span>                severity <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nhẹ&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                severity <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;bình_thường&#39;</span>
</span></span><span style="display:flex;"><span>            derived[<span style="color:#e6db74">&#39;weather_severity&#39;</span>] <span style="color:#f92672">=</span> severity
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> derived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Lỗi tính toán các trường dẫn xuất: </span><span style="color:#e6db74">{</span>str(e)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decimal_default</span>(obj):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    JSON serializer cho các đối tượng không thể serialize mặc định
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isinstance(obj, Decimal):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> float(obj)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>
</span></span></code></pre></div><h3 id="13-tạo-file-requirements">1.3 Tạo File Requirements</h3>
<p>Tạo file <code>requirements.txt</code>:</p>
<pre tabindex="0"><code>boto3==1.34.0
</code></pre><h2 id="bước-2-tạo-s3-bucket-cho-dữ-liệu-đã-xử-lý">Bước 2: Tạo S3 Bucket cho Dữ liệu Đã Xử lý</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Tạo bucket cho dữ liệu đã xử lý</span>
</span></span><span style="display:flex;"><span>aws s3 mb s3://your-weather-processed-bucket-name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bật versioning</span>
</span></span><span style="display:flex;"><span>aws s3api put-bucket-versioning <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --bucket your-weather-processed-bucket-name <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --versioning-configuration Status<span style="color:#f92672">=</span>Enabled
</span></span></code></pre></div><h2 id="bước-3-đóng-gói-và-triển-khai-hàm-lambda">Bước 3: Đóng gói và Triển khai Hàm Lambda</h2>
<h3 id="31-tạo-gói-triển-khai">3.1 Tạo Gói Triển khai</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Cài đặt dependencies</span>
</span></span><span style="display:flex;"><span>pip install -r requirements.txt -t .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tạo gói triển khai</span>
</span></span><span style="display:flex;"><span>zip -r weather-processor.zip .
</span></span></code></pre></div><h3 id="32-tạo-iam-role-cho-lambda">3.2 Tạo IAM Role cho Lambda</h3>
<p>Tạo file <code>trust-policy.json</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Version&#34;</span>: <span style="color:#e6db74">&#34;2012-10-17&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Statement&#34;</span>: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Principal&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;Service&#34;</span>: <span style="color:#e6db74">&#34;lambda.amazonaws.com&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Action&#34;</span>: <span style="color:#e6db74">&#34;sts:AssumeRole&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Tạo file <code>lambda-policy.json</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Version&#34;</span>: <span style="color:#e6db74">&#34;2012-10-17&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Statement&#34;</span>: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Action&#34;</span>: [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;logs:CreateLogGroup&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;logs:CreateLogStream&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;logs:PutLogEvents&#34;</span>
</span></span><span style="display:flex;"><span>      ],
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Resource&#34;</span>: <span style="color:#e6db74">&#34;arn:aws:logs:*:*:*&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Action&#34;</span>: [<span style="color:#e6db74">&#34;s3:GetObject&#34;</span>, <span style="color:#e6db74">&#34;s3:PutObject&#34;</span>],
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Resource&#34;</span>: [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;arn:aws:s3:::your-weather-raw-bucket/*&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;arn:aws:s3:::your-weather-processed-bucket/*&#34;</span>
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Tạo IAM role:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Tạo role</span>
</span></span><span style="display:flex;"><span>aws iam create-role <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --role-name WeatherProcessorRole <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --assume-role-policy-document file://trust-policy.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Gắn policy</span>
</span></span><span style="display:flex;"><span>aws iam put-role-policy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --role-name WeatherProcessorRole <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --policy-name WeatherProcessorPolicy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --policy-document file://lambda-policy.json
</span></span></code></pre></div><h3 id="33-triển-khai-hàm-lambda">3.3 Triển khai Hàm Lambda</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Tạo hàm Lambda</span>
</span></span><span style="display:flex;"><span>aws lambda create-function <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --function-name weather-data-processor <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --runtime python3.9 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --role arn:aws:iam::YOUR-ACCOUNT-ID:role/WeatherProcessorRole <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --handler lambda_function.lambda_handler <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --zip-file fileb://weather-processor.zip <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --timeout <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --memory-size <span style="color:#ae81ff">256</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --environment Variables<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;PROCESSED_BUCKET&#34;:&#34;your-weather-processed-bucket-name&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }&#39;</span>
</span></span></code></pre></div><h2 id="bước-4-thiết-lập-s3-event-trigger">Bước 4: Thiết lập S3 Event Trigger</h2>
<p>Cấu hình S3 để kích hoạt hàm Lambda khi có file mới được upload:</p>
<h3 id="41-thêm-quyền-lambda-cho-s3">4.1 Thêm Quyền Lambda cho S3</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws lambda add-permission <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --function-name weather-data-processor <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --principal s3.amazonaws.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --statement-id s3-trigger <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --action lambda:InvokeFunction <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --source-arn arn:aws:s3:::your-weather-raw-bucket
</span></span></code></pre></div><h3 id="42-tạo-s3-event-notification">4.2 Tạo S3 Event Notification</h3>
<p>Tạo file <code>notification-config.json</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;LambdaConfigurations&#34;</span>: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;weather-processor-trigger&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;LambdaFunctionArn&#34;</span>: <span style="color:#e6db74">&#34;arn:aws:lambda:REGION:ACCOUNT-ID:function:weather-data-processor&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Events&#34;</span>: [<span style="color:#e6db74">&#34;s3:ObjectCreated:*&#34;</span>],
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Filter&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;Key&#34;</span>: {
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;FilterRules&#34;</span>: [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;prefix&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">&#34;Value&#34;</span>: <span style="color:#e6db74">&#34;raw/&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;suffix&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">&#34;Value&#34;</span>: <span style="color:#e6db74">&#34;.json&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          ]
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Áp dụng cấu hình:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws s3api put-bucket-notification-configuration <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --bucket your-weather-raw-bucket <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --notification-configuration file://notification-config.json
</span></span></code></pre></div><h2 id="bước-5-kiểm-tra-xử-lý-dữ-liệu">Bước 5: Kiểm tra Xử lý Dữ liệu</h2>
<h3 id="51-kiểm-tra-thủ-công">5.1 Kiểm tra Thủ công</h3>
<p>Kiểm tra với file dữ liệu thời tiết mẫu:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Upload file test để kích hoạt xử lý</span>
</span></span><span style="display:flex;"><span>aws s3 cp test-weather-data.json s3://your-weather-raw-bucket/raw/test-weather-data.json
</span></span></code></pre></div><h3 id="52-kiểm-tra-cloudwatch-logs">5.2 Kiểm tra CloudWatch Logs</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Xem logs của Lambda</span>
</span></span><span style="display:flex;"><span>aws logs describe-log-groups --log-group-name-prefix /aws/lambda/weather-data-processor
</span></span></code></pre></div><h3 id="53-xác-minh-dữ-liệu-đã-xử-lý">5.3 Xác minh Dữ liệu Đã Xử lý</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Liệt kê các file đã xử lý</span>
</span></span><span style="display:flex;"><span>aws s3 ls s3://your-weather-processed-bucket/processed/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tải và kiểm tra dữ liệu đã xử lý</span>
</span></span><span style="display:flex;"><span>aws s3 cp s3://your-weather-processed-bucket/processed/test-weather-data_processed.json .
</span></span><span style="display:flex;"><span>cat test-weather-data_processed.json | jq .
</span></span></code></pre></div><h2 id="ví-dụ-biến-đổi-dữ-liệu">Ví dụ biến đổi dữ liệu</h2>
<h3 id="dữ-liệu-openweathermap-thô">Dữ liệu OpenWeatherMap thô</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;coord&#34;</span>: { <span style="color:#f92672">&#34;lon&#34;</span>: <span style="color:#ae81ff">106.6297</span>, <span style="color:#f92672">&#34;lat&#34;</span>: <span style="color:#ae81ff">10.8231</span> },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;weather&#34;</span>: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#ae81ff">803</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;main&#34;</span>: <span style="color:#e6db74">&#34;Clouds&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;broken clouds&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;icon&#34;</span>: <span style="color:#e6db74">&#34;04d&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;main&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;temp&#34;</span>: <span style="color:#ae81ff">305.15</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;feels_like&#34;</span>: <span style="color:#ae81ff">309.65</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;temp_min&#34;</span>: <span style="color:#ae81ff">305.15</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;temp_max&#34;</span>: <span style="color:#ae81ff">305.15</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;pressure&#34;</span>: <span style="color:#ae81ff">1013</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;humidity&#34;</span>: <span style="color:#ae81ff">74</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;wind&#34;</span>: { <span style="color:#f92672">&#34;speed&#34;</span>: <span style="color:#ae81ff">3.2</span>, <span style="color:#f92672">&#34;deg&#34;</span>: <span style="color:#ae81ff">220</span> },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;clouds&#34;</span>: { <span style="color:#f92672">&#34;all&#34;</span>: <span style="color:#ae81ff">75</span> },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;dt&#34;</span>: <span style="color:#ae81ff">1642248000</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;sys&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;country&#34;</span>: <span style="color:#e6db74">&#34;VN&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;sunrise&#34;</span>: <span style="color:#ae81ff">1642203600</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;sunset&#34;</span>: <span style="color:#ae81ff">1642245600</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;timezone&#34;</span>: <span style="color:#ae81ff">25200</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#ae81ff">1566083</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Ho Chi Minh City&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="dữ-liệu-đã-biến-đổi">Dữ liệu đã biến đổi</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;timestamp&#34;</span>: <span style="color:#e6db74">&#34;2025-01-15T09:00:00Z&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;city_name&#34;</span>: <span style="color:#e6db74">&#34;Ho Chi Minh City&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;country&#34;</span>: <span style="color:#e6db74">&#34;VN&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;latitude&#34;</span>: <span style="color:#ae81ff">10.8231</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;longitude&#34;</span>: <span style="color:#ae81ff">106.6297</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;temperature_celsius&#34;</span>: <span style="color:#ae81ff">32.0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;temperature_fahrenheit&#34;</span>: <span style="color:#ae81ff">89.6</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;feels_like_celsius&#34;</span>: <span style="color:#ae81ff">36.5</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;feels_like_fahrenheit&#34;</span>: <span style="color:#ae81ff">97.7</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;humidity_percent&#34;</span>: <span style="color:#ae81ff">74</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;pressure_hpa&#34;</span>: <span style="color:#ae81ff">1013</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;weather_main&#34;</span>: <span style="color:#e6db74">&#34;Clouds&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;weather_description&#34;</span>: <span style="color:#e6db74">&#34;broken clouds&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;wind_speed_ms&#34;</span>: <span style="color:#ae81ff">3.2</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;wind_speed_kmh&#34;</span>: <span style="color:#ae81ff">11.52</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;wind_speed_mph&#34;</span>: <span style="color:#ae81ff">7.16</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;wind_direction_deg&#34;</span>: <span style="color:#ae81ff">220</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;cloud_coverage_percent&#34;</span>: <span style="color:#ae81ff">75</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;heat_index_celsius&#34;</span>: <span style="color:#ae81ff">38.2</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;heat_index_fahrenheit&#34;</span>: <span style="color:#ae81ff">100.8</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;comfort_level&#34;</span>: <span style="color:#e6db74">&#34;nóng&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;wind_condition&#34;</span>: <span style="color:#e6db74">&#34;nhẹ&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;weather_severity&#34;</span>: <span style="color:#e6db74">&#34;bình_thường&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;data_collection_date&#34;</span>: <span style="color:#e6db74">&#34;2025-01-15&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="giám-sát-và-khắc-phục-sự-cố">Giám sát và Khắc phục Sự cố</h2>
<h3 id="cloudwatch-metrics">CloudWatch Metrics</h3>
<p>Giám sát các chỉ số quan trọng:</p>
<ul>
<li>Số lần gọi Lambda</li>
<li>Lỗi và thời gian thực thi</li>
<li>Metrics của S3 bucket</li>
</ul>
<h3 id="các-vấn-đề-thường-gặp">Các Vấn đề Thường gặp</h3>
<ol>
<li><strong>Lỗi Quyền</strong>: Đảm bảo Lambda có quyền S3 thích hợp</li>
<li><strong>Vấn đề Bộ nhớ</strong>: Tăng bộ nhớ Lambda nếu xử lý file lớn</li>
<li><strong>Timeout</strong>: Điều chỉnh timeout Lambda cho các biến đổi phức tạp</li>
</ol>
<h2 id="lợi-ích-của-biến-đổi-dữ-liệu">Lợi ích của biến đổi dữ liệu</h2>
<ul>
<li><strong>Cải thiện hiệu suất truy vấn</strong>: Cấu trúc phẳng dễ truy vấn hơn</li>
<li><strong>Giảm chi phí lưu trữ</strong>: Định dạng dữ liệu tối ưu sử dụng ít dung lượng hơn</li>
<li><strong>Nâng cao phân tích</strong>: Các trường dẫn xuất cho phép hiểu sâu hơn</li>
<li><strong>Chất lượng dữ liệu tốt hơn</strong>: Xác thực đảm bảo dữ liệu đáng tin cậy</li>
</ul>
<h2 id="các-bước-tiếp-theo">Các bước tiếp theo</h2>
<p>Sau khi hoàn thành module này, bạn sẽ có một pipeline biến đổi dữ liệu hoạt động đầy đủ để chuẩn bị dữ liệu thời tiết của bạn cho phân tích. Trong module tiếp theo, chúng ta sẽ sử dụng Amazon Athena để truy vấn và phân tích dữ liệu đã xử lý này.</p>

<div class="notices tip" ><p>Biến đổi dữ liệu là nơi bạn có thể thêm kiến thức chuyên ngành của mình. Hãy xem xét các chỉ số thời tiết bổ sung nào có thể hữu ích cho nhu cầu phân tích cụ thể của bạn.</p>
</div>


<div class="notices warning" ><p>Nhớ thay thế các giá trị placeholder (YOUR-ACCOUNT-ID, REGION, tên bucket) bằng thông tin AWS account thực tế của bạn.</p>
</div>






<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/vi/2-data-collection-openweathermap/2.4-testing-monitoring/" title="Testing và Monitoring Thu thập Thời tiết"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/vi/4-data-storage-solutions/" title="Phân tích Dữ liệu với Athena" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1752217735"></script>
    <script src="/js/perfect-scrollbar.min.js?1752217735"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1752217735"></script>
    <script src="/js/jquery.sticky.js?1752217735"></script>
    <script src="/js/featherlight.min.js?1752217735"></script>
    <script src="/js/highlight.pack.js?1752217735"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1752217735"></script>
    <script src="/js/learn.js?1752217735"></script>
    <script src="/js/hugo-learn.js?1752217735"></script>

    <link href="/mermaid/mermaid.css?1752217735" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1752217735"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
