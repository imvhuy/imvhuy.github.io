<!DOCTYPE html>
<html lang="vi" class="js csstransforms3d">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.147.8">
    <meta name="description" content="Build a complete weather data ETL pipeline using AWS Lambda, S3, Athena, and QuickSight">
<meta name="author" content="Dang Van Huy">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Xây dựng Lambda Weather Collector :: Hệ thống ETL Dữ liệu Thời tiết với AWS</title>

    
    <link href="/css/nucleus.css?1752242330" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1752242330" rel="stylesheet">
    <link href="/css/hybrid.css?1752242330" rel="stylesheet">
    <link href="/css/featherlight.min.css?1752242330" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1752242330" rel="stylesheet">
    <link href="/css/auto-complete.css?1752242330" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1752242330" rel="stylesheet">
    <link href="/css/theme.css?1752242330" rel="stylesheet">
    <link href="/css/hugo-theme.css?1752242330" rel="stylesheet">
    
    <link href="/css/theme-workshop.css?1752242330" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1752242330"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/vi/2-data-collection-openweathermap/2.2-lambda-weather-collector/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1752242330"></script>
<script type="text/javascript" src="/js/auto-complete.js?1752242330"></script>
<script type="text/javascript">
    
        var baseurl = "\/\/localhost:1313\/\/vi";
    
</script>
<script type="text/javascript" src="/js/search.js?1752242330"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/vi/1-introduction/" title="Giới thiệu" class="dd-item 
        
        
        
        ">
      <a href="/vi/1-introduction/">
          <b>1. </b>Giới thiệu
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/2-data-collection-openweathermap/" title="Thu thập Dữ liệu Thời tiết với OpenWeatherMap" class="dd-item 
        parent
        
        
        ">
      <a href="/vi/2-data-collection-openweathermap/">
          <b>2. </b>Thu thập Dữ liệu Thời tiết với OpenWeatherMap
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/vi/2-data-collection-openweathermap/2.1-openweathermap-setup/" title="Thiết lập OpenWeatherMap API" class="dd-item 
        
        
        
        ">
      <a href="/vi/2-data-collection-openweathermap/2.1-openweathermap-setup/">
          Thiết lập OpenWeatherMap API
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/2-data-collection-openweathermap/2.2-lambda-weather-collector/" title="Xây dựng Lambda Weather Collector" class="dd-item 
        
        active
        
        ">
      <a href="/vi/2-data-collection-openweathermap/2.2-lambda-weather-collector/">
          Xây dựng Lambda Weather Collector
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/2-data-collection-openweathermap/2.3-automated-scheduling/" title="Lập lịch Tự động với CloudWatch Events" class="dd-item 
        
        
        
        ">
      <a href="/vi/2-data-collection-openweathermap/2.3-automated-scheduling/">
          Lập lịch Tự động với CloudWatch Events
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/2-data-collection-openweathermap/2.4-testing-monitoring/" title="Testing và Monitoring Thu thập Thời tiết" class="dd-item 
        
        
        
        ">
      <a href="/vi/2-data-collection-openweathermap/2.4-testing-monitoring/">
          Testing và Monitoring Thu thập Thời tiết
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/3-serverless-processing-lambda/" title="Xử lý và Chuyển đổi Dữ liệu" class="dd-item 
        
        
        
        ">
      <a href="/vi/3-serverless-processing-lambda/">
          <b>3. </b>Xử lý và Chuyển đổi Dữ liệu
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/4-data-storage-solutions/" title="Phân tích Dữ liệu với Athena" class="dd-item 
        
        
        
        ">
      <a href="/vi/4-data-storage-solutions/">
          <b>4. </b>Phân tích Dữ liệu với Athena
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/5-analytics-visualization/" title="Trực quan hóa Dữ liệu với QuickSight" class="dd-item 
        
        
        
        ">
      <a href="/vi/5-analytics-visualization/">
          <b>5. </b>Trực quan hóa Dữ liệu với QuickSight
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/6-cleanup-next-steps/" title="Dọn dẹp Tài nguyên và Bước tiếp theo" class="dd-item 
        
        
        
        ">
      <a href="/vi/6-cleanup-next-steps/">
          <b>6. </b>Dọn dẹp Tài nguyên và Bước tiếp theo
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="http://awsstudygroup.com"><i class='fab fa-aws'></i> AWS Study Group - Blog</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="//localhost:1313/vi/2-data-collection-openweathermap/2.2-lambda-weather-collector/" selected>Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
     
    
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>23-06-2025</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Author </b> <br>
           
            <i>
                <a href="https://www.linkedin.com/in/imvhuy/"  style="color:orange">Đặng Văn Huy</a>
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/vi/'>Xây dựng Pipeline ETL Thời tiết Serverless</a> > <a href='/vi/2-data-collection-openweathermap/'>Thu thập Dữ liệu Thời tiết với OpenWeatherMap</a> > Xây dựng Lambda Weather Collector
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#tại-sao-cần-iam-role">Tại sao cần IAM Role?</a></li>
    <li><a href="#bước-1-tạo-iam-role-cho-lambda">Bước 1: Tạo IAM Role cho Lambda</a>
      <ul>
        <li><a href="#11-tạo-lambda-execution-role">1.1 Tạo Lambda Execution Role</a></li>
        <li><a href="#12-gắn-aws-managed-policies">1.2 Gắn AWS Managed Policies</a></li>
      </ul>
    </li>
    <li><a href="#bước-2-tạo-s3-bucket-cho-dữ-liệu-thời-tiết">Bước 2: Tạo S3 Bucket cho Dữ liệu Thời tiết</a>
      <ul>
        <li><a href="#21-tạo-weather-data-bucket">2.1 Tạo Weather Data Bucket</a></li>
      </ul>
    </li>
    <li><a href="#bước-3-lambda-function-cho-current-weather">Bước 3: Lambda Function cho Current Weather</a>
      <ul>
        <li><a href="#31-tạo-current-weather-function">3.1 Tạo Current Weather Function</a></li>
        <li><a href="#32-function-code">3.2 Function Code</a></li>
        <li><a href="#33-biến-môi-trường">3.3 Biến Môi trường</a></li>
        <li><a href="#34-cấu-hình-function">3.4 Cấu hình Function</a></li>
      </ul>
    </li>
    <li><a href="#bước-4-lambda-function-cho-weather-forecast">Bước 4: Lambda Function cho Weather Forecast</a>
      <ul>
        <li><a href="#41-tạo-forecast-function">4.1 Tạo Forecast Function</a></li>
        <li><a href="#42-forecast-function-code">4.2 Forecast Function Code</a></li>
      </ul>
    </li>
    <li><a href="#bước-5-testing-lambda-functions">Bước 5: Testing Lambda Functions</a>
      <ul>
        <li><a href="#51-test-manual">5.1 Test Manual</a></li>
        <li><a href="#52-verify-s3-data">5.2 Verify S3 Data</a></li>
      </ul>
    </li>
    <li><a href="#tóm-tắt">Tóm tắt</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Xây dựng Lambda Weather Collector
            </h1>
          

        



	<p>Trong phần này, chúng ta sẽ tạo các hàm AWS Lambda để tự động thu thập dữ liệu thời tiết từ OpenWeatherMap API và lưu trữ vào S3. Những hàm này sẽ là lõi của hệ thống thu thập dữ liệu thời tiết.</p>
<h2 id="tại-sao-cần-iam-role">Tại sao cần IAM Role?</h2>
<p><strong>IAM Role</strong> giống như một &ldquo;thẻ căn cước&rdquo; cho Lambda function, cho phép nó truy cập các dịch vụ AWS khác. Không có IAM Role, Lambda function sẽ:</p>
<p><strong>KHÔNG THỂ</strong> lưu file vào S3<br>
<strong>KHÔNG THỂ</strong> đọc API key từ Parameter Store<br>
<strong>KHÔNG THỂ</strong> ghi logs vào CloudWatch<br>
<strong>KHÔNG THỂ</strong> gửi metrics cho monitoring</p>
<p>Với IAM Role phù hợp:</p>
<p>Lambda có thể lưu dữ liệu thời tiết vào S3<br>
Lambda có thể đọc API key an toàn<br>
Lambda có thể ghi logs để debug<br>
Lambda có thể gửi metrics để monitoring</p>
<h2 id="bước-1-tạo-iam-role-cho-lambda">Bước 1: Tạo IAM Role cho Lambda</h2>
<h3 id="11-tạo-lambda-execution-role">1.1 Tạo Lambda Execution Role</h3>
<ol>
<li>
<p><strong>Điều hướng đến IAM Console</strong></p>
<ul>
<li>AWS Console → IAM → Roles</li>
<li>Click &ldquo;Create role&rdquo;</li>
</ul>
</li>
<li>
<p><strong>Chọn Trusted Entity</strong></p>
<ul>
<li><strong>Service</strong>: Lambda</li>
<li>Click &ldquo;Next&rdquo;
<img src="/images/data-collection/22b1.png" alt="Trusted Entity"></li>
</ul>
</li>
<li>
<p><strong>Cấu hình Role</strong></p>
<ul>
<li><strong>Role Name</strong>: <code>WeatherCollectorLambdaRole</code></li>
<li><strong>Description</strong>: <code>Execution role for weather data collection Lambda functions</code></li>
</ul>
</li>
</ol>
<h3 id="12-gắn-aws-managed-policies">1.2 Gắn AWS Managed Policies</h3>
<p><strong>AWS Managed Policy là gì?</strong></p>
<p>AWS đã tạo sẵn nhiều policies phổ biến mà chúng ta có thể &ldquo;gắn&rdquo; (attach) vào Role thay vì tự viết từ đầu. Điều này tiết kiệm thời gian và đảm bảo bảo mật.</p>
<p><strong>Cách gắn các policies trong AWS Console:</strong></p>
<ol>
<li><strong>Khi tạo Role</strong> <code>WeatherCollectorLambdaRole</code>, ở bước &ldquo;Add permissions&rdquo;</li>
<li><strong>Tab &ldquo;Permissions&rdquo;</strong> → Click &ldquo;Attach policies directly&rdquo;</li>
<li><strong>Tìm kiếm và chọn từng policy sau:</strong>
<ul>
<li>✅ Gõ <code>AWSLambdaBasicExecutionRole</code> → tick chọn</li>
<li>✅ Gõ <code>AmazonS3FullAccess</code> → tick chọn</li>
<li>✅ Gõ <code>AmazonSSMReadOnlyAccess</code> → tick chọn</li>
<li>✅ Gõ <code>CloudWatchAgentServerPolicy</code> → tick chọn</li>
</ul>
</li>
<li><strong>Click &ldquo;Add Permissions&rdquo;</strong> và hoàn thành tạo role</li>
</ol>
<p><img src="/images/data-collection/22b11.png" alt="Managed Policies"></p>
<p><strong>Kết quả:</strong>
Role <code>WeatherCollectorLambdaRole</code> sẽ có <strong>4 managed policies</strong></p>
<p><strong>Policy này cho phép Lambda:</strong></p>
<ul>
<li><strong>Tạo CloudWatch Log Group</strong> để ghi logs</li>
<li><strong>Ghi logs vào CloudWatch</strong> khi function chạy</li>
<li><strong>Basic networking</strong> để Lambda hoạt động</li>
</ul>
<h2 id="bước-2-tạo-s3-bucket-cho-dữ-liệu-thời-tiết">Bước 2: Tạo S3 Bucket cho Dữ liệu Thời tiết</h2>
<h3 id="21-tạo-weather-data-bucket">2.1 Tạo Weather Data Bucket</h3>
<ol>
<li>
<p><strong>Điều hướng đến S3 Console</strong></p>
<ul>
<li>AWS Console → S3 → Create bucket</li>
</ul>
</li>
</ol>
<p><img src="/images/data-collection/22b21.png" alt="S3"></p>
<ol start="2">
<li>
<p><strong>Cấu hình Bucket</strong></p>
<ul>
<li><strong>Bucket Name</strong>: <code>weather-data-{your-account-id}</code> (thay thế bằng AWS account ID của bạn)</li>
<li><strong>Region</strong>: us-east-1 (hoặc region ưa thích của bạn)</li>
<li><strong>Block Public Access</strong>: Giữ tất cả cài đặt được bật (khuyến nghị)</li>
</ul>
</li>
<li>
<p><strong>Cấu trúc Bucket</strong></p>
<pre tabindex="0"><code>weather-data-123456789012/
├── raw/
│   ├── current-weather/
│   │   └── year=2025/month=01/day=03/hour=10/
│   └── forecast/
│       └── year=2025/month=01/day=03/
└── processed/
    ├── current-weather/
    └── forecast/
</code></pre></li>
</ol>
<h2 id="bước-3-lambda-function-cho-current-weather">Bước 3: Lambda Function cho Current Weather</h2>
<h3 id="31-tạo-current-weather-function">3.1 Tạo Current Weather Function</h3>
<ol>
<li>
<p><strong>Điều hướng đến Lambda Console</strong></p>
<ul>
<li>AWS Console → Lambda → Create function</li>
</ul>
</li>
<li>
<p><strong>Cấu hình Function</strong></p>
<ul>
<li><strong>Function Name</strong>: <code>weather-current-collector</code></li>
<li><strong>Runtime</strong>: Python 3.11</li>
<li><strong>Architecture</strong>: x86_64</li>
<li><strong>Execution Role</strong>: Use existing role → <code>WeatherCollectorLambdaRole</code></li>
</ul>
</li>
</ol>
<h3 id="32-function-code">3.2 Function Code</h3>
<p><strong>File</strong>: <code>lambda_function.py</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> boto3
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime, timezone
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict, List, Optional
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cấu hình logging</span>
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger()
</span></span><span style="display:flex;"><span>logger<span style="color:#f92672">.</span>setLevel(logging<span style="color:#f92672">.</span>INFO)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AWS clients</span>
</span></span><span style="display:flex;"><span>s3_client <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;s3&#39;</span>)
</span></span><span style="display:flex;"><span>ssm_client <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;ssm&#39;</span>)
</span></span><span style="display:flex;"><span>cloudwatch <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;cloudwatch&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cấu hình</span>
</span></span><span style="display:flex;"><span>BUCKET_NAME <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;WEATHER_BUCKET_NAME&#39;</span>)
</span></span><span style="display:flex;"><span>API_KEY_PARAMETER <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/weather-etl/openweathermap/api-key&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Các thành phố mục tiêu để thu thập thời tiết</span>
</span></span><span style="display:flex;"><span>CITIES <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Ho Chi Minh City&#39;</span>, <span style="color:#e6db74">&#39;country&#39;</span>: <span style="color:#e6db74">&#39;VN&#39;</span>, <span style="color:#e6db74">&#39;lat&#39;</span>: <span style="color:#ae81ff">10.8231</span>, <span style="color:#e6db74">&#39;lon&#39;</span>: <span style="color:#ae81ff">106.6297</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Hanoi&#39;</span>, <span style="color:#e6db74">&#39;country&#39;</span>: <span style="color:#e6db74">&#39;VN&#39;</span>, <span style="color:#e6db74">&#39;lat&#39;</span>: <span style="color:#ae81ff">21.0285</span>, <span style="color:#e6db74">&#39;lon&#39;</span>: <span style="color:#ae81ff">105.8542</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Singapore&#39;</span>, <span style="color:#e6db74">&#39;country&#39;</span>: <span style="color:#e6db74">&#39;SG&#39;</span>, <span style="color:#e6db74">&#39;lat&#39;</span>: <span style="color:#ae81ff">1.3521</span>, <span style="color:#e6db74">&#39;lon&#39;</span>: <span style="color:#ae81ff">103.8198</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Bangkok&#39;</span>, <span style="color:#e6db74">&#39;country&#39;</span>: <span style="color:#e6db74">&#39;TH&#39;</span>, <span style="color:#e6db74">&#39;lat&#39;</span>: <span style="color:#ae81ff">13.7563</span>, <span style="color:#e6db74">&#39;lon&#39;</span>: <span style="color:#ae81ff">100.5018</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Jakarta&#39;</span>, <span style="color:#e6db74">&#39;country&#39;</span>: <span style="color:#e6db74">&#39;ID&#39;</span>, <span style="color:#e6db74">&#39;lat&#39;</span>: <span style="color:#f92672">-</span><span style="color:#ae81ff">6.2088</span>, <span style="color:#e6db74">&#39;lon&#39;</span>: <span style="color:#ae81ff">106.8456</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Kuala Lumpur&#39;</span>, <span style="color:#e6db74">&#39;country&#39;</span>: <span style="color:#e6db74">&#39;MY&#39;</span>, <span style="color:#e6db74">&#39;lat&#39;</span>: <span style="color:#ae81ff">3.1390</span>, <span style="color:#e6db74">&#39;lon&#39;</span>: <span style="color:#ae81ff">101.6869</span>}
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_api_key</span>() <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Lấy OpenWeatherMap API key từ Parameter Store.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> ssm_client<span style="color:#f92672">.</span>get_parameter(
</span></span><span style="display:flex;"><span>            Name<span style="color:#f92672">=</span>API_KEY_PARAMETER,
</span></span><span style="display:flex;"><span>            WithDecryption<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> response[<span style="color:#e6db74">&#39;Parameter&#39;</span>][<span style="color:#e6db74">&#39;Value&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Không thể lấy API key: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fetch_current_weather</span>(city: Dict, api_key: str) <span style="color:#f92672">-&gt;</span> Optional[Dict]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Lấy dữ liệu thời tiết hiện tại cho một thành phố.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    base_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://api.openweathermap.org/data/2.5/weather&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    params <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;lat&#39;</span>: city[<span style="color:#e6db74">&#39;lat&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;lon&#39;</span>: city[<span style="color:#e6db74">&#39;lon&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;appid&#39;</span>: api_key,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;units&#39;</span>: <span style="color:#e6db74">&#39;metric&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;lang&#39;</span>: <span style="color:#e6db74">&#39;vi&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(base_url, params<span style="color:#f92672">=</span>params, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span>raise_for_status()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Thêm metadata</span>
</span></span><span style="display:flex;"><span>        data[<span style="color:#e6db74">&#39;collection_timestamp&#39;</span>] <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>now(timezone<span style="color:#f92672">.</span>utc)<span style="color:#f92672">.</span>isoformat()
</span></span><span style="display:flex;"><span>        data[<span style="color:#e6db74">&#39;city_metadata&#39;</span>] <span style="color:#f92672">=</span> city
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> requests<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>RequestException <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Lỗi API cho </span><span style="color:#e6db74">{</span>city[<span style="color:#e6db74">&#39;name&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> json<span style="color:#f92672">.</span>JSONDecodeError <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Lỗi JSON decode cho </span><span style="color:#e6db74">{</span>city[<span style="color:#e6db74">&#39;name&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">save_to_s3</span>(data: Dict, city_name: str) <span style="color:#f92672">-&gt;</span> bool:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Lưu dữ liệu thời tiết vào S3.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>now(timezone<span style="color:#f92672">.</span>utc)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Tạo S3 key với partition theo thời gian</span>
</span></span><span style="display:flex;"><span>        city_safe <span style="color:#f92672">=</span> city_name<span style="color:#f92672">.</span>lower()<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39; &#39;</span>, <span style="color:#e6db74">&#39;_&#39;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;.&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;raw/current-weather/year=</span><span style="color:#e6db74">{</span>now<span style="color:#f92672">.</span>year<span style="color:#e6db74">}</span><span style="color:#e6db74">/month=</span><span style="color:#e6db74">{</span>now<span style="color:#f92672">.</span>month<span style="color:#e6db74">:</span><span style="color:#e6db74">02d</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/day=</span><span style="color:#e6db74">{</span>now<span style="color:#f92672">.</span>day<span style="color:#e6db74">:</span><span style="color:#e6db74">02d</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/hour=</span><span style="color:#e6db74">{</span>now<span style="color:#f92672">.</span>hour<span style="color:#e6db74">:</span><span style="color:#e6db74">02d</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>city_safe<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>now<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">_%H%M%S&#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">.json&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Upload file</span>
</span></span><span style="display:flex;"><span>        s3_client<span style="color:#f92672">.</span>put_object(
</span></span><span style="display:flex;"><span>            Bucket<span style="color:#f92672">=</span>BUCKET_NAME,
</span></span><span style="display:flex;"><span>            Key<span style="color:#f92672">=</span>key,
</span></span><span style="display:flex;"><span>            Body<span style="color:#f92672">=</span>json<span style="color:#f92672">.</span>dumps(data, ensure_ascii<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, indent<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>            ContentType<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;application/json&#39;</span>,
</span></span><span style="display:flex;"><span>            Metadata<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;city&#39;</span>: city_name,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;collection_time&#39;</span>: now<span style="color:#f92672">.</span>isoformat(),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;data_type&#39;</span>: <span style="color:#e6db74">&#39;current_weather&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Đã lưu dữ liệu cho </span><span style="color:#e6db74">{</span>city_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> tại </span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Lỗi lưu S3 cho </span><span style="color:#e6db74">{</span>city_name<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_metrics</span>(metric_name: str, value: float, unit: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Count&#39;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Gửi metrics tùy chỉnh tới CloudWatch.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        cloudwatch<span style="color:#f92672">.</span>put_metric_data(
</span></span><span style="display:flex;"><span>            Namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Weather/ETL&#39;</span>,
</span></span><span style="display:flex;"><span>            MetricData<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;MetricName&#39;</span>: metric_name,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;Value&#39;</span>: value,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;Unit&#39;</span>: unit,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;Timestamp&#39;</span>: datetime<span style="color:#f92672">.</span>now(timezone<span style="color:#f92672">.</span>utc)
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Lỗi gửi metric </span><span style="color:#e6db74">{</span>metric_name<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lambda_handler</span>(event, context):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Handler chính cho Lambda function.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Bắt đầu thu thập thời tiết: </span><span style="color:#e6db74">{</span>json<span style="color:#f92672">.</span>dumps(event)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    successful_collections <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    failed_collections <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    results <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Lấy API key</span>
</span></span><span style="display:flex;"><span>        api_key <span style="color:#f92672">=</span> get_api_key()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Thu thập dữ liệu cho từng thành phố</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> city <span style="color:#f92672">in</span> CITIES:
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Thu thập dữ liệu cho </span><span style="color:#e6db74">{</span>city[<span style="color:#e6db74">&#39;name&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Fetch weather data</span>
</span></span><span style="display:flex;"><span>            weather_data <span style="color:#f92672">=</span> fetch_current_weather(city, api_key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> weather_data:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Lưu vào S3</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> save_to_s3(weather_data, city[<span style="color:#e6db74">&#39;name&#39;</span>]):
</span></span><span style="display:flex;"><span>                    successful_collections <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                    results<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;city&#39;</span>: city[<span style="color:#e6db74">&#39;name&#39;</span>],
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;status&#39;</span>: <span style="color:#e6db74">&#39;success&#39;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;temperature&#39;</span>: weather_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;main&#39;</span>, {})<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;temp&#39;</span>),
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;description&#39;</span>: weather_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;weather&#39;</span>, [{}])[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;description&#39;</span>)
</span></span><span style="display:flex;"><span>                    })
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    failed_collections <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                    results<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;city&#39;</span>: city[<span style="color:#e6db74">&#39;name&#39;</span>],
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;status&#39;</span>: <span style="color:#e6db74">&#39;failed&#39;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;error&#39;</span>: <span style="color:#e6db74">&#39;S3 save failed&#39;</span>
</span></span><span style="display:flex;"><span>                    })
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                failed_collections <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                results<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;city&#39;</span>: city[<span style="color:#e6db74">&#39;name&#39;</span>],
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;status&#39;</span>: <span style="color:#e6db74">&#39;failed&#39;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;error&#39;</span>: <span style="color:#e6db74">&#39;API fetch failed&#39;</span>
</span></span><span style="display:flex;"><span>                })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Gửi metrics</span>
</span></span><span style="display:flex;"><span>        send_metrics(<span style="color:#e6db74">&#39;SuccessfulCollections&#39;</span>, successful_collections)
</span></span><span style="display:flex;"><span>        send_metrics(<span style="color:#e6db74">&#39;FailedCollections&#39;</span>, failed_collections)
</span></span><span style="display:flex;"><span>        send_metrics(<span style="color:#e6db74">&#39;TotalCollections&#39;</span>, successful_collections <span style="color:#f92672">+</span> failed_collections)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Log kết quả</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Thu thập hoàn tất - Thành công: </span><span style="color:#e6db74">{</span>successful_collections<span style="color:#e6db74">}</span><span style="color:#e6db74">, Thất bại: </span><span style="color:#e6db74">{</span>failed_collections<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;body&#39;</span>: json<span style="color:#f92672">.</span>dumps({
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;message&#39;</span>: <span style="color:#e6db74">&#39;Thu thập thời tiết hoàn tất&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;successful_collections&#39;</span>: successful_collections,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;failed_collections&#39;</span>: failed_collections,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;results&#39;</span>: results
</span></span><span style="display:flex;"><span>            }, ensure_ascii<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Lỗi trong lambda handler: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        send_metrics(<span style="color:#e6db74">&#39;LambdaErrors&#39;</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">500</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;body&#39;</span>: json<span style="color:#f92672">.</span>dumps({
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;error&#39;</span>: <span style="color:#e6db74">&#39;Lỗi nội bộ&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;message&#39;</span>: str(e)
</span></span><span style="display:flex;"><span>            }, ensure_ascii<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><h3 id="33-biến-môi-trường">3.3 Biến Môi trường</h3>
<p>Trong Lambda Console, thêm biến môi trường:</p>
<ul>
<li><strong>WEATHER_BUCKET_NAME</strong>: <code>weather-data-{your-account-id}</code></li>
</ul>
<h3 id="34-cấu-hình-function">3.4 Cấu hình Function</h3>
<ul>
<li><strong>Memory</strong>: 256 MB</li>
<li><strong>Timeout</strong>: 5 minutes</li>
<li><strong>Reserved Concurrency</strong>: 2</li>
</ul>
<h2 id="bước-4-lambda-function-cho-weather-forecast">Bước 4: Lambda Function cho Weather Forecast</h2>
<h3 id="41-tạo-forecast-function">4.1 Tạo Forecast Function</h3>
<ol>
<li><strong>Tạo function mới</strong>
<ul>
<li><strong>Function Name</strong>: <code>weather-forecast-collector</code></li>
<li><strong>Runtime</strong>: Python 3.11</li>
<li><strong>Execution Role</strong>: <code>WeatherCollectorLambdaRole</code></li>
</ul>
</li>
</ol>
<h3 id="42-forecast-function-code">4.2 Forecast Function Code</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> boto3
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime, timezone
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict, List, Optional
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger()
</span></span><span style="display:flex;"><span>logger<span style="color:#f92672">.</span>setLevel(logging<span style="color:#f92672">.</span>INFO)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s3_client <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;s3&#39;</span>)
</span></span><span style="display:flex;"><span>ssm_client <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;ssm&#39;</span>)
</span></span><span style="display:flex;"><span>cloudwatch <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;cloudwatch&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BUCKET_NAME <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;WEATHER_BUCKET_NAME&#39;</span>)
</span></span><span style="display:flex;"><span>API_KEY_PARAMETER <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/weather-etl/openweathermap/api-key&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CITIES <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Ho Chi Minh City&#39;</span>, <span style="color:#e6db74">&#39;country&#39;</span>: <span style="color:#e6db74">&#39;VN&#39;</span>, <span style="color:#e6db74">&#39;lat&#39;</span>: <span style="color:#ae81ff">10.8231</span>, <span style="color:#e6db74">&#39;lon&#39;</span>: <span style="color:#ae81ff">106.6297</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Hanoi&#39;</span>, <span style="color:#e6db74">&#39;country&#39;</span>: <span style="color:#e6db74">&#39;VN&#39;</span>, <span style="color:#e6db74">&#39;lat&#39;</span>: <span style="color:#ae81ff">21.0285</span>, <span style="color:#e6db74">&#39;lon&#39;</span>: <span style="color:#ae81ff">105.8542</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Singapore&#39;</span>, <span style="color:#e6db74">&#39;country&#39;</span>: <span style="color:#e6db74">&#39;SG&#39;</span>, <span style="color:#e6db74">&#39;lat&#39;</span>: <span style="color:#ae81ff">1.3521</span>, <span style="color:#e6db74">&#39;lon&#39;</span>: <span style="color:#ae81ff">103.8198</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Bangkok&#39;</span>, <span style="color:#e6db74">&#39;country&#39;</span>: <span style="color:#e6db74">&#39;TH&#39;</span>, <span style="color:#e6db74">&#39;lat&#39;</span>: <span style="color:#ae81ff">13.7563</span>, <span style="color:#e6db74">&#39;lon&#39;</span>: <span style="color:#ae81ff">100.5018</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Jakarta&#39;</span>, <span style="color:#e6db74">&#39;country&#39;</span>: <span style="color:#e6db74">&#39;ID&#39;</span>, <span style="color:#e6db74">&#39;lat&#39;</span>: <span style="color:#f92672">-</span><span style="color:#ae81ff">6.2088</span>, <span style="color:#e6db74">&#39;lon&#39;</span>: <span style="color:#ae81ff">106.8456</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Kuala Lumpur&#39;</span>, <span style="color:#e6db74">&#39;country&#39;</span>: <span style="color:#e6db74">&#39;MY&#39;</span>, <span style="color:#e6db74">&#39;lat&#39;</span>: <span style="color:#ae81ff">3.1390</span>, <span style="color:#e6db74">&#39;lon&#39;</span>: <span style="color:#ae81ff">101.6869</span>}
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_api_key</span>() <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Lấy OpenWeatherMap API key từ Parameter Store.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> ssm_client<span style="color:#f92672">.</span>get_parameter(
</span></span><span style="display:flex;"><span>            Name<span style="color:#f92672">=</span>API_KEY_PARAMETER,
</span></span><span style="display:flex;"><span>            WithDecryption<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> response[<span style="color:#e6db74">&#39;Parameter&#39;</span>][<span style="color:#e6db74">&#39;Value&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Không thể lấy API key: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fetch_weather_forecast</span>(city: Dict, api_key: str) <span style="color:#f92672">-&gt;</span> Optional[Dict]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Lấy dữ liệu dự báo thời tiết 5 ngày cho một thành phố.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    base_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://api.openweathermap.org/data/2.5/forecast&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    params <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;lat&#39;</span>: city[<span style="color:#e6db74">&#39;lat&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;lon&#39;</span>: city[<span style="color:#e6db74">&#39;lon&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;appid&#39;</span>: api_key,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;units&#39;</span>: <span style="color:#e6db74">&#39;metric&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;lang&#39;</span>: <span style="color:#e6db74">&#39;vi&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;cnt&#39;</span>: <span style="color:#ae81ff">40</span>  <span style="color:#75715e"># 5 ngày x 8 dự báo (mỗi 3 giờ)</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(base_url, params<span style="color:#f92672">=</span>params, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span>raise_for_status()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Thêm metadata</span>
</span></span><span style="display:flex;"><span>        data[<span style="color:#e6db74">&#39;collection_timestamp&#39;</span>] <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>now(timezone<span style="color:#f92672">.</span>utc)<span style="color:#f92672">.</span>isoformat()
</span></span><span style="display:flex;"><span>        data[<span style="color:#e6db74">&#39;city_metadata&#39;</span>] <span style="color:#f92672">=</span> city
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> requests<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>RequestException <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Lỗi API forecast cho </span><span style="color:#e6db74">{</span>city[<span style="color:#e6db74">&#39;name&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> json<span style="color:#f92672">.</span>JSONDecodeError <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Lỗi JSON decode forecast cho </span><span style="color:#e6db74">{</span>city[<span style="color:#e6db74">&#39;name&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">save_forecast_to_s3</span>(data: Dict, city_name: str) <span style="color:#f92672">-&gt;</span> bool:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Lưu dữ liệu dự báo thời tiết vào S3.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>now(timezone<span style="color:#f92672">.</span>utc)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        city_safe <span style="color:#f92672">=</span> city_name<span style="color:#f92672">.</span>lower()<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39; &#39;</span>, <span style="color:#e6db74">&#39;_&#39;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;.&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;raw/forecast/year=</span><span style="color:#e6db74">{</span>now<span style="color:#f92672">.</span>year<span style="color:#e6db74">}</span><span style="color:#e6db74">/month=</span><span style="color:#e6db74">{</span>now<span style="color:#f92672">.</span>month<span style="color:#e6db74">:</span><span style="color:#e6db74">02d</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/day=</span><span style="color:#e6db74">{</span>now<span style="color:#f92672">.</span>day<span style="color:#e6db74">:</span><span style="color:#e6db74">02d</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>city_safe<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>now<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">_%H%M%S&#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">.json&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        s3_client<span style="color:#f92672">.</span>put_object(
</span></span><span style="display:flex;"><span>            Bucket<span style="color:#f92672">=</span>BUCKET_NAME,
</span></span><span style="display:flex;"><span>            Key<span style="color:#f92672">=</span>key,
</span></span><span style="display:flex;"><span>            Body<span style="color:#f92672">=</span>json<span style="color:#f92672">.</span>dumps(data, ensure_ascii<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, indent<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>            ContentType<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;application/json&#39;</span>,
</span></span><span style="display:flex;"><span>            Metadata<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;city&#39;</span>: city_name,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;collection_time&#39;</span>: now<span style="color:#f92672">.</span>isoformat(),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;data_type&#39;</span>: <span style="color:#e6db74">&#39;forecast&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;forecast_count&#39;</span>: str(len(data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;list&#39;</span>, [])))
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Đã lưu dự báo cho </span><span style="color:#e6db74">{</span>city_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> tại </span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Lỗi lưu forecast S3 cho </span><span style="color:#e6db74">{</span>city_name<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lambda_handler</span>(event, context):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Handler chính cho forecast Lambda function.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Bắt đầu thu thập dự báo thời tiết: </span><span style="color:#e6db74">{</span>json<span style="color:#f92672">.</span>dumps(event)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    successful_collections <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    failed_collections <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    results <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        api_key <span style="color:#f92672">=</span> get_api_key()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> city <span style="color:#f92672">in</span> CITIES:
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Thu thập dự báo cho </span><span style="color:#e6db74">{</span>city[<span style="color:#e6db74">&#39;name&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            forecast_data <span style="color:#f92672">=</span> fetch_weather_forecast(city, api_key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> forecast_data:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> save_forecast_to_s3(forecast_data, city[<span style="color:#e6db74">&#39;name&#39;</span>]):
</span></span><span style="display:flex;"><span>                    successful_collections <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                    results<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;city&#39;</span>: city[<span style="color:#e6db74">&#39;name&#39;</span>],
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;status&#39;</span>: <span style="color:#e6db74">&#39;success&#39;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;forecast_points&#39;</span>: len(forecast_data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;list&#39;</span>, []))
</span></span><span style="display:flex;"><span>                    })
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    failed_collections <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                    results<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;city&#39;</span>: city[<span style="color:#e6db74">&#39;name&#39;</span>],
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;status&#39;</span>: <span style="color:#e6db74">&#39;failed&#39;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;error&#39;</span>: <span style="color:#e6db74">&#39;S3 save failed&#39;</span>
</span></span><span style="display:flex;"><span>                    })
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                failed_collections <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                results<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;city&#39;</span>: city[<span style="color:#e6db74">&#39;name&#39;</span>],
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;status&#39;</span>: <span style="color:#e6db74">&#39;failed&#39;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;error&#39;</span>: <span style="color:#e6db74">&#39;API fetch failed&#39;</span>
</span></span><span style="display:flex;"><span>                })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Gửi metrics</span>
</span></span><span style="display:flex;"><span>        cloudwatch<span style="color:#f92672">.</span>put_metric_data(
</span></span><span style="display:flex;"><span>            Namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Weather/ETL&#39;</span>,
</span></span><span style="display:flex;"><span>            MetricData<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;MetricName&#39;</span>: <span style="color:#e6db74">&#39;SuccessfulForecastCollections&#39;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;Value&#39;</span>: successful_collections,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;Unit&#39;</span>: <span style="color:#e6db74">&#39;Count&#39;</span>
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;MetricName&#39;</span>: <span style="color:#e6db74">&#39;FailedForecastCollections&#39;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;Value&#39;</span>: failed_collections,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;Unit&#39;</span>: <span style="color:#e6db74">&#39;Count&#39;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Thu thập dự báo hoàn tất - Thành công: </span><span style="color:#e6db74">{</span>successful_collections<span style="color:#e6db74">}</span><span style="color:#e6db74">, Thất bại: </span><span style="color:#e6db74">{</span>failed_collections<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;body&#39;</span>: json<span style="color:#f92672">.</span>dumps({
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;message&#39;</span>: <span style="color:#e6db74">&#39;Thu thập dự báo thời tiết hoàn tất&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;successful_collections&#39;</span>: successful_collections,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;failed_collections&#39;</span>: failed_collections,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;results&#39;</span>: results
</span></span><span style="display:flex;"><span>            }, ensure_ascii<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Lỗi trong forecast lambda handler: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cloudwatch<span style="color:#f92672">.</span>put_metric_data(
</span></span><span style="display:flex;"><span>            Namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Weather/ETL&#39;</span>,
</span></span><span style="display:flex;"><span>            MetricData<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;MetricName&#39;</span>: <span style="color:#e6db74">&#39;ForecastLambdaErrors&#39;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;Value&#39;</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;Unit&#39;</span>: <span style="color:#e6db74">&#39;Count&#39;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">500</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;body&#39;</span>: json<span style="color:#f92672">.</span>dumps({
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;error&#39;</span>: <span style="color:#e6db74">&#39;Lỗi nội bộ forecast&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;message&#39;</span>: str(e)
</span></span><span style="display:flex;"><span>            }, ensure_ascii<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><h2 id="bước-5-testing-lambda-functions">Bước 5: Testing Lambda Functions</h2>
<h3 id="51-test-manual">5.1 Test Manual</h3>
<ol>
<li>
<p><strong>Test current weather function</strong></p>
<ul>
<li>Vào Lambda Console → <code>weather-current-collector</code></li>
<li>Tạo test event với payload rỗng <code>{}</code></li>
<li>Click &ldquo;Test&rdquo; và kiểm tra logs</li>
</ul>
</li>
<li>
<p><strong>Test forecast function</strong></p>
<ul>
<li>Vào Lambda Console → <code>weather-forecast-collector</code></li>
<li>Tạo test event với payload rỗng <code>{}</code></li>
<li>Click &ldquo;Test&rdquo; và kiểm tra logs</li>
</ul>
</li>
</ol>
<h3 id="52-verify-s3-data">5.2 Verify S3 Data</h3>
<p>Kiểm tra dữ liệu trong S3 bucket:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws s3 ls s3://weather-data-<span style="color:#f92672">{</span>your-account-id<span style="color:#f92672">}</span>/raw/ --recursive
</span></span></code></pre></div><p>Bạn sẽ thấy các file JSON được tạo trong cấu trúc partition theo thời gian.</p>
<h2 id="tóm-tắt">Tóm tắt</h2>
<p>Trong phần này, chúng ta đã:</p>
<p>✅ Tạo IAM roles và policies cho Lambda functions<br>
✅ Thiết lập S3 bucket với cấu trúc partition<br>
✅ Xây dựng Lambda function thu thập thời tiết hiện tại<br>
✅ Xây dựng Lambda function thu thập dự báo thời tiết<br>
✅ Cấu hình error handling và CloudWatch metrics<br>
✅ Test các functions thành công</p>
<p><strong>Tiếp theo</strong>: Trong module 2.3, chúng ta sẽ thiết lập automated scheduling với CloudWatch Events để chạy các functions này theo lịch trình.</p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/vi/2-data-collection-openweathermap/2.1-openweathermap-setup/" title="Thiết lập OpenWeatherMap API"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/vi/2-data-collection-openweathermap/2.3-automated-scheduling/" title="Lập lịch Tự động với CloudWatch Events" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1752242330"></script>
    <script src="/js/perfect-scrollbar.min.js?1752242330"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1752242330"></script>
    <script src="/js/jquery.sticky.js?1752242330"></script>
    <script src="/js/featherlight.min.js?1752242330"></script>
    <script src="/js/highlight.pack.js?1752242330"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1752242330"></script>
    <script src="/js/learn.js?1752242330"></script>
    <script src="/js/hugo-learn.js?1752242330"></script>

    <link href="/mermaid/mermaid.css?1752242330" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1752242330"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
